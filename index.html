<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title> Grading Exam Papers </title>
<script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- bootstrap -->
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script> 
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>  

    <!-- x-editable (bootstrap version) -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet"/>
    <script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.4.6/bootstrap-editable/js/bootstrap-editable.min.js"></script>
    <script src="fabric/fabric.js"> </script>

  <script type="text/javascript">

var Upload = function (file, tool, input) {
    this.file = file;
    this.tool = tool;
    this.input = input;
};

Upload.prototype.getType = function() {
    return this.file.type;
};
Upload.prototype.getSize = function() {
    return this.file.size;
};
Upload.prototype.getName = function() {
    return this.file.name;
};
Upload.prototype.doUpload = function () {
    var that = this;
    var formData = new FormData();

    // add assoc key values, this will be posts values
    formData.append("uploads", this.file, this.getName());
    formData.append("go", "upload");
    formData.append("tool", this.tool);
    formData.append("input", this.input);

    $.ajax({
        type: "POST",
        url: "grade.php",
        xhr: function () {
            var myXhr = $.ajaxSettings.xhr();
            if (myXhr.upload) {
                myXhr.upload.addEventListener('progress', that.progressHandling, false);
            }
            return myXhr;
        },
        success: function (data) {
            // your callback here
          $('#uploadstatus').append("Successfully uploaded: " + that.getName());
          $('#uploadstatus').append("<br/>");
          $('#uploadstatus').append(data);
        },
        error: function (error) {
            // handle error
          $('#uploadstatus').append("Error in Uploading: " + that.getName());
          $('#uploadstatus').append("<br/>");
        },
        async: true,
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        timeout: 60000
    });
};

Upload.prototype.progressHandling = function (event) {
    var percent = 0;
    var position = event.loaded || event.position;
    var total = event.total;
    var progress_bar_id = "#progress-wrp";
    if (event.lengthComputable) {
        percent = Math.ceil(position / total * 100);
    }
    // update progressbars classes so it fits your code
    $(progress_bar_id + " .progress-bar").css("width", +percent + "%");
    $(progress_bar_id + " .status").text(percent + "%");
};

function callUpload() {
  var files = $('#selectedfile')[0].files;
  var tool = $('#select-tools').val();
  var input = $('#inputtext').val();
  if (/^admin/.test(input) && (tool == "Roster" || tool == "Upload Scans")) {
    for (var i = 0; i < files.length; i++) {
      var upload = new Upload(files[i], tool, input);

      // maby check size or type here with upload.getSize() and upload.getType()

      // execute upload
      upload.doUpload();
    }
  }
  return false;
}

function callClear() {
  //$('#inputtext').val("");
  $('#uploadstatus').html("");
  var percent = 0;
  var progress_bar_id = "#progress-wrp";
  $(progress_bar_id + " .progress-bar").css("width", +percent + "%");
  $(progress_bar_id + " .status").text(percent + "%");
}

var ident = function (d) { return d; };
function ShowID(input, tool) {
  this.input = input;
  this.tool = tool;
  this.fc = null;
  this.img = null;
  if (this.init) {
    this.init(input);
  }
}

(function() {

fabric.util.object.extend(fabric.Object.prototype, {
  annStr: "Unknown",
  annPage: -1 });

  ShowID.prototype.init_vars = function() {
    this.fc = null;
    this.img = null;
    this.rect = null;
    this.startDrawing = false;
    this.started = false;
    this.stx = 0;
    this.sty = 0;
    this.currPage = 1;
    this.dType = null;
  }

  ShowID.prototype.addAnnotation = function(obj) {
    var curr = this;
    curr.fc.add(obj);
    curr.callUpdate();
  }

  ShowID.prototype.removeAnnotation = function(obj) {
    var curr = this;
    curr.fc.remove(obj);
    curr.callUpdate();
  }

  ShowID.prototype.init = function(input) {
    var curr = this;
    curr.init_vars();

    d3.json("grade.php?go=getPages&input=" + input,
        function (data) {
          curr.data = data;
          d3.select("#templateContainer").html("");
          var reftable = d3.select("#templateContainer").append("table")
            .attr("id", "ptable").attr("border", 0);
          var ctable = d3.select("#templateContainer").append("table")
            .attr("id", "ctable").attr("border", 0);
          var ctr = ctable.append("tr");
          var ctd1 = ctr.append("td");
          var ctd2 = ctr.append("td").attr("align", "left")
            .attr("valign", "top");
          var imgc = ctd1.append("div").attr("style",
                "margin: 0 auto; width:850px;height:1100px");
          var stn = ctd2.append("div").attr("id", "nameinfo");
          var st = ctd2.append("div").attr("id", "objlist");
          var c = imgc
            .append("canvas").attr("id", "imgCanvas").attr("width", "850px")
            .attr("height", "1100px");
          var canvas = new fabric.Canvas('imgCanvas');
          curr.fc = canvas;
          fabric.Image.fromURL(data[0][2], function(oImg) {
            // scale image down, and flip it, before adding it onto canvas
            oImg.scale(0.5);
            oImg.hasControls = false;
            oImg.lockMovementX = false;
            oImg.lockMovementY = false;
            oImg.lockRotation = oImg.lockScalingX = oImg.lockScalingY = false;
            oImg.selectable = false;
            canvas.add(oImg);
            curr.img = oImg;
          });
          canvas.selection=false;
          var idx = $.map($(Array(data.length + 3)),function(v, i) { return i; });
          var pages = reftable.append("tr").selectAll("td").data(idx)
            .enter().append("td").html(function (d) { 
              if (d == 0) { return "Pages:"; }
              else if (d == data.length + 1) { return "Name"; }
              else if (d == data.length + 2) { return "Region"; }
              else {
                return data[d - 1][1]; } })
            .style("width", "50px").style("text-align", "center")
            .on('mouseover', function(){
              d3.select(this).style('background-color', 'gray');})
            .on('mouseout', function(){
              d3.select(this).style('background-color', 'white');})
            .on("click", function(d) {
              var obj = d3.select(this).data();
              if (obj[0] > 0 && obj[0] < data.length + 1) {
                curr.img.setSrc(data[obj[0] - 1][2], function (d) {
                  curr.currPage = obj[0];
                  curr.hideObjects();
                  canvas.renderAll();
                });
              }
              else if (obj[0] == data.length + 1) {
                curr.startDrawing = true;
                curr.dType = "Name";
              }
              else if (obj[0] == data.length + 2) {
                curr.startDrawing = true;
                curr.dType = "Region";
              }
            });
          curr.addEvents();
          curr.callLoad();
          curr.showName(data[0][3]);
        });
  }

  ShowID.prototype.getNameObj = function() {
    var curr = this;
    if (curr.fc) {
      var objs = curr.fc.getObjects();
      for (var i =0; i < objs.length; i++) {
        if (objs[i].get('annStr') == "Name" &&
            objs[i].get('annPage') > 0 && 
            objs[i].get('annPage') == curr.currPage) {
          return objs[i];
        }
      }
    }
    return null;
  }

  ShowID.prototype.appendTable = function(id, data, columns, callback) {
    var curr = this;
    var reftable = d3.select(id).append("table")
      .attr("border", 0);
    var refthead = reftable.append("thead"),
    reftbody = reftable.append("tbody");
    refthead.append("tr").selectAll("th").data(columns)
      .enter().append("th").attr("align", "left").text(ident);
    reftbody.selectAll("tr").data(data)
      .enter().append("tr").selectAll("td").data(ident)
      .enter().append("td").html(ident);
    reftbody.selectAll("tr")
      .on('mouseover', function(){
        d3.select(this).style('background-color', 'gray');})
      .on('mouseout', function(){
        d3.select(this).style('background-color', 'white');})
      .on("click", function(d) {
        var obj = d3.select(this).data();
        d3.json("grade.php?go=matchStudent&scanid=" + curr.data[0][0] +
            "&studentid=" + obj[0][0], ident);
        callback(obj);
      });
  }

  ShowID.prototype.showName = function(id) {
    var curr = this;
    d3.select("#nameinfo").html("");
    var ntable = d3.select("#nameinfo").append("table")
      .attr("id", "ntable").attr("border", 0);
    if (id && id < 0) {
      ntable.append("tr").selectAll("td").data(["Name: ", "Unknown"])
        .enter().append("td").html(ident);
    }
    else {
      d3.json("grade.php?go=getName&input=" + id,
          function (data) {
            ntable.append("tr").selectAll("td").data(data)
              .enter().append("td").html(ident);
          });
    }
    if (curr.tool == "Match") {
      d3.select("#nameinfo").append("br");
      var cell = d3.select("#nameinfo").append("input")
        .attr("type", "text").attr("style", 'width: 100px')
        .attr("id", "namesearch");
      var cell2 = d3.select("#nameinfo").append("input")
        .attr("type", "button").attr("value", "Search")
        .on("click", function() {
          var str = d3.select("#namesearch").node().value;
          d3.json("grade.php?go=searchName&input=" + str,
              function (data) {
                var cols = ["ID", "lastName", "firstName", "userName",
                "studentID"];
                curr.appendTable("#nameinfo", data, cols, function(obj) {
                  console.log(obj);
                  ntable.html("");
                  ntable.append("tr").selectAll("td").data(obj[0])
                    .enter().append("td").html(ident);
                });
              });
        });
    }
  }

  ShowID.prototype.addEvents = function() {
    var curr = this;
    if (curr.fc && curr.tool == "Template") {
      curr.fc.observe('mouse:down', function(event) {
        if(!curr.startDrawing) {
          return false;
        }
        var mouse = curr.fc.getPointer(event.e);
        curr.started = true;
        curr.stx = mouse.x;
        curr.sty = mouse.y;
        var obj = new fabric.Rect({
          width: 1, height: 1, left: mouse.x, top: mouse.y, 
          stroke: 'blue', strokeWidth: 1, fill : '',
          annStr: curr.dType,
          annPage: curr.currPage
        });
        curr.addAnnotation(obj); 
        curr.fc.renderAll();
        curr.fc.setActiveObject(obj);
      });
      curr.fc.observe('mouse:move', function(event) {
        if(!curr.startDrawing || !curr.started) {
          return false;
        }
        var mouse = curr.fc.getPointer(event.e);
        var x = Math.min(mouse.x,  curr.stx),
        y = Math.min(mouse.y,  curr.sty),
        w = Math.abs(mouse.x - curr.stx),
        h = Math.abs(mouse.y - curr.sty);
        var r = Math.max(w, h)/2;
        if (!w || !h) {
          return false;
        }
        var obj = curr.fc.getActiveObject(); 
        obj.set('top', y).set('left', x)
          .set('width', w).set('height', h);
        curr.fc.renderAll(); 
      });
      curr.fc.observe('mouse:up', function(event) {
        if (curr.started) {
          curr.started = false;
          curr.startDrawing = false;
        }
      });
    }

  }

  ShowID.prototype.callUpdate = function() {
    var curr = this;
    if (curr.fc && curr.tool == "Template") {
      var objs = curr.fc.getObjects();
      d3.select("#objlist").html("");
      var reftable = d3.select("#objlist").append("table")
        .attr("id", "reftable").attr("border", 0);
      var refthead = reftable.append("thead"),
      reftbody = reftable.append("tbody");
      var data = ["Index", "Page", "Annotation", "BBox"];
      refthead.append("tr").selectAll("th").data(data)
        .enter().append("th").attr("align", "left").text(ident);
      reftbody.selectAll("tr").data(objs)
        .enter().append("tr").selectAll("td").data(function (d, i) {
          var bound = d.getBoundingRect(true, true);
          var bbox = [d.get('left'), d.get('top'), d.get('width'),
          d.get('height')];
          var bbox = [bound.left, bound.top, bound.width, bound.height];
          bbox = bbox.map(function(x){return Math.ceil(x);});
          var bboxstr = JSON.stringify(bbox);
          return [i, d.get('annPage'), d.get('annStr'), bboxstr];
        }).enter().append("td").html(ident);
      reftbody.selectAll("tr")
        .on('mouseover', function(){
          d3.select(this).style('background-color', 'gray');})
        .on('mouseout', function(){
          d3.select(this).style('background-color', 'white');})
        .on("click", function(d) {
          var obj = d3.select(this).data();
          if (curr.fc.contains(obj[0])) {
            curr.fc.setActiveObject(obj[0]);
          }
        });
      reftbody.selectAll("tr").selectAll("td")
        .filter(function (d, i) { return i == 0; })
        .html(function(d) {
          var index = d3.select(this).data();
          return index + "&nbsp&nbsp";
        })
      .append("img")
        .attr("src", function (d) { return "images/remove-icon-20.png"; })
        .attr("width", 15).attr("height", 15)
        .on("click", function(d, i){
          var obj = d3.select(this.parentNode.parentNode).data();
          curr.removeAnnotation(obj[0]);
        });
      reftbody.selectAll("tr").selectAll("td")
        .filter(function (d, i) { return i == 2; })
        .each(function (d) {
          var cell = d3.select(this);
          var obj = d3.select(this.parentNode).data();
          $(cell.node()).editable({
            type: 'text',
            placement: 'bottom',
            defaultValue: 'Unknown',
            tpl: "<input type='text' style='width: 100px'>",
            success: function(response, newValue) {
              obj[0].set('annStr', newValue);
            }
          });
        });
    }
  }

  ShowID.prototype.hideObjects = function() {
    var curr = this;
    if (curr.fc) {
      var objs = curr.fc.getObjects();
      for (var i =0; i < objs.length; i++) {
        objs[i].opacity = 1;
        if (objs[i].get('type') != "image" &&
            objs[i].get('annPage') > 0 && 
            objs[i].get('annPage') != curr.currPage) {
          objs[i].opacity = 0;
        }
      }
      curr.fc.discardActiveObject();
    }
  }

  ShowID.prototype.callSave = function() {
    var curr = this;
    if (curr.tool == "Template") {
      var objs = curr.fc.getObjects();
      var arr = [];
      for (var i =0; i < objs.length; i++) {
        var obj = objs[i];
        if (obj.get('type') != "image") {
          var bound = obj.getBoundingRect(true, true);
          var bbox = [bound.left, bound.top, bound.width, bound.height];
          bbox = bbox.map(function(x){return Math.ceil(x);});
          var zoom = [2, 2];
          arr.push([i, obj.annStr, obj.annPage, bbox, zoom, obj.toObject()]);
        }
      }
      var res = arr;
      $.ajax({type: 'POST',
        data: {go: "saveTemplate", input: JSON.stringify(res)},
        url: "grade.php"});
    }
  }

  ShowID.prototype.callLoad = function() {
    var curr = this;
    d3.json('grade.php?go=getTemplate',
        function (error,data) {
          var arr = data;
          if (!arr) { return; }
          var ins = {rect:fabric.Rect, circle:fabric.Circle,
            triangle:fabric.Triangle, ellipse:fabric.Ellipse,
            path:fabric.Path};
          for (i = 0; i < arr.length; i++) {
            ins[arr[i][5].type].fromObject(arr[i][5], function (obj) {
              obj.set('annStr', arr[i][1]);
              obj.set('annPage', arr[i][2]);
              curr.addAnnotation(obj);
              if (i == (arr.length - 1)) {
                curr.hideObjects();
              }
            });
          }
        });
  }


})();

var currScan = null;
function callShow() {
  var tool = $('#select-tools').val();
  var input = $('#inputtext').val();
  if (tool == "Template" || tool == "Match") {
    currScan = new ShowID(input, tool);
  }
}

function callSave() {
  var tool = $('#select-tools').val();
  var input = $('#inputtext').val();
  if (tool == "Template" && currScan) {
    currScan.callSave();
  }
}
  </script>

  <style>
    html, body {
      margin: 0px;
      background-color: white;
    }

    #select-tools {
      width: unset;
      padding: unset;
      margin: unset;
    }
#progress-wrp {
    border: 1px solid #0099CC;
    padding: 1px;
    position: relative;
    height: 30px;
    border-radius: 3px;
    margin: 10px;
    text-align: left;
    background: #fff;
    box-shadow: inset 1px 3px 6px rgba(0, 0, 0, 0.12);
}
#progress-wrp .progress-bar{
    height: 100%;
    border-radius: 3px;
    background-color: #f39ac7;
    width: 0;
    box-shadow: inset 1px 1px 10px rgba(0, 0, 0, 0.11);
}
#progress-wrp .status{
    top:3px;
    left:50%;
    position:absolute;
    display:inline-block;
    color: #000000;
}
  </style>
  </head>
  <body>
    <h1> Grading Exam Papers </h1>
    <h2>Tools </h2>
    <form action="grade.php" 
      method="post" ENCTYPE="multipart/form-data">
      <table border="0">
        <tr><td>
            Select:
      <select id="select-tools">
        <option>Match</option>
        <option>Template</option>
        <option>Grade</option>
        <option>Roster</option>
        <option>Upload Scans</option>
        <option>None</option>
      </select>
          </td><td>
          </td></tr>
        <tr><td>
      Input: <input type="text" id="inputtext" name="input" size="20"/> 
          </td><td>
      <input type="button" name="Show" value="Show"
            onclick="return callShow();"/>
      <input type="button" name="Save" value="Save"
            onclick="return callSave();"/>
          </td></tr>
        <tr><td>
      File: <input id="selectedfile" type="file" name="uploads[]" size="30" multiple=""/>
          </td><td>
      <input type="submit" value="Upload" onclick="return callUpload();"/>
      <input type="button" value="Clear" onclick="return callClear();"/>
          </td></tr>
        <tr><td>
<div id="progress-wrp">
    <div class="progress-bar"></div>
    <div class="status">0%</div>
</div>
          </td><td>
            <div id="uploadstatus"></div>
          </td></tr>
        <tr><td>
      </table>
    </form>
    <div id="templateContainer"> </div>
  </body>
</html>
